<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=KOI8-R" />
<meta name="generator" content="AsciiDoc 7.1.2" />
<style type="text/css">
/* Debug borders */
p, li, dt, dd, div, pre, h1, h2, h3, h4, h5, h6 {
/*
  border: 1px solid red;
*/
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
}

strong {
  font-weight: bold;
}

tt {
  color: navy;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  font-family: sans-serif;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1 {
  border-bottom: 2px solid silver;
}
h2 {
  border-bottom: 2px solid silver;
  padding-top: 0.5em;
}

div.sectionbody {
  font-family: serif;
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

pre {
  padding: 0;
  margin: 0;
}

span#author {
  color: #527bbd;
  font-family: sans-serif;
  font-weight: bold;
  font-size: 1.2em;
}
span#email {
}
span#revision {
  font-family: sans-serif;
}

div#footer {
  font-family: sans-serif;
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
div#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
div#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

div#preamble,
div.tableblock, div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-right: 10%;
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.5em;
  margin-bottom: 2.5em;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  font-family: sans-serif;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid silver;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid silver;
  background: #f4f4f4;
  padding: 0.5em;
}

div.quoteblock > div.content {
  padding-left: 2.0em;
}

div.attribution {
  text-align: right;
}
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 2px solid silver;
}

div.exampleblock > div.content {
  border-left: 2px solid silver;
  padding: 0.5em;
}

div.verseblock div.content {
  white-space: pre;
}

div.imageblock div.content { padding-left: 0; }
div.imageblock img { border: 1px solid silver; }
span.image img { border-style: none; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: italic;
}
dd > *:first-child {
  margin-top: 0;
}

ul, ol {
    list-style-position: outside;
}
ol.olist2 {
  list-style-type: lower-alpha;
}

div.tableblock > table {
  border: 3px solid #527bbd;
}
thead {
  font-family: sans-serif;
  font-weight: bold;
}
tfoot {
  font-weight: bold;
}

div.hlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
td.hlist1 {
  vertical-align: top;
  font-style: italic;
  padding-right: 0.8em;
}
td.hlist2 {
  vertical-align: top;
}

@media print {
  div#footer-badges { display: none; }
}
/* Workarounds for IE6's broken and incomplete CSS2. */

div.sidebar-content {
  background: #ffffee;
  border: 1px solid silver;
  padding: 0.5em;
}
div.sidebar-title, div.image-title {
  font-family: sans-serif;
  font-weight: bold;
  margin-top: 0.0em;
  margin-bottom: 0.5em;
}

div.listingblock div.content {
  border: 1px solid silver;
  background: #f4f4f4;
  padding: 0.5em;
}

div.quoteblock-content {
  padding-left: 2.0em;
}

div.exampleblock-content {
  border-left: 2px solid silver;
  padding-left: 0.5em;
}
</style>
<title>От SRPMS к GEAR</title>
</head>
<body>
<div id="header">
<h1>От SRPMS к GEAR</h1>
<span id="author">Dmitry V. Levin</span><br />
23 июля 2007 года
</div>
<h2>Abstract</h2>
<div class="sectionbody">
<p>Основной смысл хранения исходного кода пакетов в
<a href="http://kernel.org/pub/software/scm/git/docs/">git-репозитории</a>
заключается в более эффективной и удобной совместной разработке, а также
в минимизации используемого дискового пространства для хранения архива
репозитория за длительный срок и минимизации трафика при обновлении
исходного кода.</p>
<p>Идея
<a href="http://git.altlinux.org/people/ldv/packages/?p=gear.git;a=blob_plain;f=gear.1.html;hb=html"><tt>gear(1)</tt></a>
заключается в том, чтобы с помощью одного файла с простыми правилами
(для обработки которых достаточно <tt>sed</tt> и <tt>git</tt>) можно было бы собирать
пакеты из произвольно устроенного git-репозитория, по аналогии с
<a href="http://ftp.altlinux.org/pub/people/ldv/hasher/"><tt>hasher(7)</tt></a>, который
был задуман как средство собирать пакеты из произвольных srpm-пакетов.</p>
</div>
<h2>Структура репозитория</h2>
<div class="sectionbody">
<p>Хотя gear и не накладывает ограничений на внутреннюю организацию
git-репозитория (не считая требования наличия файла с правилами), есть
несколько соображений о том, как более эффективно и удобно организовывать
git-репозитории, предназначенные для хранения исходного кода пакетов.</p>
<h3>Одна сущность &#8212; один репозиторий</h3>
<p>Не стоит помещать в один репозиторий несколько разных пакетов, за
исключением случаев, когда у этих пакетов есть общий пакет-предок.</p>
<ul>
<li>
<p>
Плюсы:
Соблюдение этого правила облегчает совместную работу над пакетом,
поскольку не перегруженный репозиторий легче клонировать и в целом
инструментарий <tt>git</tt> больше подходит для работы с такими репозиториями.
</p>
</li>
<li>
<p>
Минусы:
Несколько сложнее выполнять операции fetch и push в случае, когда
репозиториев, которые надо обработать, много.  Впрочем, fetch/push
в цикле выручает.
</p>
</li>
</ul>
<h3>Несжатый исходный код</h3>
<p>Сжатый разными средствами (<tt>gzip</tt>, <tt>bzip2</tt> и т.п.) исходный код лучше
хранить в git-репозитории в несжатом виде.</p>
<ul>
<li>
<p>
Плюсы:
Изменение файлов, которые помещены в репозиторий в сжатом виде, менее
удобно отслеживать штатными средствами (<tt>git diff</tt>).  Поскольку <tt>git</tt>
хранит объекты в сжатом виде, двойное сжатие редко приводит к экономии
дискового пространства.  Наконец, алгоритм, применяемый для минимизации
трафика при обновлении репозитория по протоколу <tt>git</tt>, более эффективен
на несжатых данных.
</p>
</li>
<li>
<p>
Минусы:
Поскольку некоторые виды сжатия одних и тех же данных могут приводить к
разным результатам, может уменьшиться степень первозданности (нативности)
исходного кода.
</p>
</li>
</ul>
<h3>Распакованный исходный код</h3>
<p>Исходный код, запакованный архиваторами (<tt>tar</tt>, <tt>cpio</tt>, <tt>zip</tt> и т.п.),
лучше хранить в git-репозитории в распакованном виде.</p>
<ul>
<li>
<p>
Плюсы:
Существенно удобнее вносить изменения в конечные файлы и отслеживать
изменения в них, заметно меньше трафик при обновлении.
</p>
</li>
<li>
<p>
Минусы:
Поскольку <tt>git</tt> из информации о владельце, правах доступа и дате
модификации файлов хранит только исполняемость файлов, любой архив,
созданный из репозитория, будет по этим параметрам отличаться от
первозданного.  Помимо потери нативности, изменение прав доступа и даты
модификации может теоретически повлиять на результат сборки пакета.
Впрочем, сборку таких пакетов, если они будут обнаружены, всё равно
придётся исправить.
</p>
</li>
</ul>
<h3>Форматированный changelog</h3>
<p>В changelog релизного commit'а имеет смысл включать соответствующий
текст из changelog'а пакета, как это делают утилиты <tt>gear-commit</tt>
(обёртка к <tt>git commit</tt>, специально предназначенная для этих целей) и
<tt>gear-srpmimport</tt>.  В результате можно будет получить представление об
изменениях в очередном релизе пакета, не заглядывая в spec-файл самого
пакета.</p>
</div>
<h2>Правила экспорта</h2>
<div class="sectionbody">
<p>С одной стороны, для того, чтобы srpm-пакет мог быть импортирован в
git-репозиторий наиболее удобным для пользователя способом, язык правил,
согласно которым производится экспорт из коммита репозитория (в форму,
из которой можно однозначно изготовить srpm-пакет или запустить сборку),
должен быть достаточно выразительным.</p>
<p>С другой стороны, для того, чтобы можно было относительно безбоязненно
собирать пакеты из чужих gear-репозиториев, этот язык правил должен быть
достаточно простым.</p>
<p>Файл правил экспорта (по умолчанию <tt>.gear/rules</tt>) состоит из строк формата</p>
<div class="listingblock">
<div class="content">
<pre><tt>директива: параметры</tt></pre>
</div></div>
<p>параметры разделяются пробельными символами.</p>
<p>Директивы позволяют экспортировать:
- любой файл из дерева, соответствующего коммиту;
- любой каталог из дерева, соответствующего коммиту в виде tar- или zip-архива;
- unified diff между любыми каталогами, соответствующими коммитам.</p>
<p>Файлы на выходе могут быть сжаты с помощью <tt>gzip</tt> или <tt>bzip2</tt>.  В качестве
коммита может быть указан как целевой коммит (значение параметра <tt>-t</tt>
утилиты <tt>gear</tt>, так и любой из его предков при соблюдении условий,
гарантирующих однозначное вычисление полного имени коммита-предка по
целевому коммиту.</p>
<p>Правила экспорта из gear-репозитория описаны детально в
<a href="http://git.altlinux.org/people/ldv/packages/?p=gear.git;a=blob_plain;f=gear-rules.5.html;hb=html"><tt>gear-rules(5)</tt></a>.</p>
</div>
<h2>Основные типы устройства gear-репозитория</h2>
<div class="sectionbody">
<p>Правила экспорта реализуют основные типы устройства gear-репозитория
следующим образом:</p>
<h3>Архив с модифицированным исходным кодом</h3>
<p>С помощью простого правила</p>
<div class="listingblock">
<div class="content">
<pre><tt>tar: .</tt></pre>
</div></div>
<p>всё дерево исходного кода экспортируется в один tar-архив.  Если у
проекта есть upstream, публикующий tar-архивы, то добавление релиза в
имя tar-архива, например, с помощью правила</p>
<div class="listingblock">
<div class="content">
<pre><tt>tar: . name=@name@-@version@-@release@</tt></pre>
</div></div>
<p>позволяет избежать коллизий.</p>
<h3>Архив с немодифицированным исходным кодом и патчем, содержащем локальные изменения</h3>
<p>С помощью двух правил,</p>
<div class="listingblock">
<div class="content">
<pre><tt>tar: v@version@:.
diff: v@version@:. .</tt></pre>
</div></div>
<p>можно экспортировать всё дерево исходного кода в виде tar-архива
с немодифицированным исходным кодом, помеченным тэгом <tt>v@version@</tt>,
и патча, который нужно приложить к дереву с немодифицированным кодом
для того, чтобы получить дерево с исходным кодом.  Тэг <tt>v@version@</tt>
должен быть зарегистрирован с помощью утилиты <tt>gear-update-tag</tt>.</p>
<h3>Архив с немодифицированным исходным кодом и отдельными патчами</h3>
<p>Если дерево с немодифицированным исходным кодом хранится в отдельном
подкаталоге, а локальные изменения хранятся в gear-репозитории в виде
отдельных патч-файлов, то правила экспорта могут выглядеть следующим
образом:</p>
<div class="listingblock">
<div class="content">
<pre><tt>tar: package_name
copy: *.patch</tt></pre>
</div></div>
<p>Такое устройство репозитория получается при использовании утилиты
<tt>gear-srpmimport</tt>, предназначенной для быстрой миграции от srpm-файла
к gear-репозиторию.</p>
<h3>Смешанные типы</h3>
<p>Вышеперечисленные типы устройства gear-репозитория являются основными,
но не исчерпывающими.  Правила экспорта достаточно выразительны для
того, чтобы реализовать всевозможные сочетания основных типов и создать
полнофункциональный gear-репозиторий на любой вкус.</p>
</div>
<div id="footer">
<div id="footer-text">
Last updated 17-Mar-2008
</div>
</div>
</body>
</html>
